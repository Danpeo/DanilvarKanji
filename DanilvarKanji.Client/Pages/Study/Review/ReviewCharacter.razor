@page "/review/{CharacterLearningId}"

@using DanilvarKanji.Shared.Responses.Character
@using DanilvarKanji.Domain.Enumerations
@using DanilvarKanji.Shared.Responses.CharacterLearning
@using DanilvarKanji.Client.Services.Characters
@using DanilvarKanji.Client.Services.Review
@using DanilvarKanji.Shared.Requests.Exercises
@using DanilvarKanji.Client.Localization
@using DanilvarKanji.Client.State
@using DanilvarKanji.Shared.Requests.Reviews
@using DanilvarKanji.Shared.Responses.Exercise
@using DanilvarKanji.Shared.Responses.Review

<ForbidIfNotAuthorized>
    @if (_character is not null)
    {
        <DisplayCharacterDefinition Character="_character"/>
        <p>@_character.Id</p>
        @_exercises[_currentExcercise]

        <div class="d-grid gap-4 mt-4">
            <button class="btn btn-lg btn-danger" @onclick="async () => { await OnIncorrectMeaning(); await GoToNextExerciseOrFinish(); }">
                Skip
            </button>
        </div>
    }
    else
    {
        <DisplayLoading/>
    }



</ForbidIfNotAuthorized>


@code {

    [Parameter, EditorRequired]
    public required string CharacterLearningId { get; set; }

    [Inject]
    public required AppState AppState { get; set; }

    [Inject]
    public required ICharacterLearningService CharacterLearningService { get; set; }

    [Inject]
    public required ICharacterService CharacterService { get; set; }

    [Inject]
    public required IExerciseService ExerciseService { get; set; }

    [Inject]
    public required ILocalizationService LocalizationService { get; set; }

    [Inject]
    public required IReviewService ReviewService { get; set; }

    [Inject]
    public required NavigationManager NavigationManager { get; set; }

        private const int AfterAnswerDelay = 250;
    private int _currentExcercise;
    private bool _reviewFinished;

    private GetAllFromCharacterLearningResponse? _learning;
    private GetAllFromCharacterResponse? _character;
    private Culture _culture;
    private List<RenderFragment> _exercises = new();
    private ReviewSession _reviewSession;
    private GetBaseReviewSessionResponse _reviewSessionResponse = new();
    private CreateReviewSessionRequest _createReviewSessionRequest = new();

    protected override async Task OnInitializedAsync()
    {
        _culture = await LocalizationService.GetCurrentCulture();

        _learning = await CharacterLearningService.GetLearningAsync(CharacterLearningId);
        _character = await CharacterService.GetCharacterAsync(_learning?.Character.Id);

        InitExercises();

        if (_currentExcercise == 0)
            await AppState.ReviewSessionState.NewReviewSession();

        _reviewSession = AppState.ReviewSessionState.ReviewSession;
    }

    private void InitExercises()
    {
        _exercises.Add(@<div class="fade-in-el">
                           <VerifyOnyomiByPointing
                               CharacterForVerification="_character"
                               Culture="_culture"
                               OnCorrect="@(() => OnCorrectPointExercise(ExerciseType.Onyomi))"
                               OnIncorrect="OnIncorrectMeaning"/>
                       </div>);

        _exercises.Add(@<div class="fade-in-el">
                           <VerifyKunyomiByPointing
                               CharacterForVerification="_character"
                               Culture="_culture"
                               OnCorrect="@(() => OnCorrectPointExercise(ExerciseType.Kunyomi))"
                               OnIncorrect="OnIncorrectMeaning"/>
                       </div>);

        _exercises.Add(@<div class="fade-in-el">
                           <VerifyOnyomiByInput
                               OnConfirm="OnConfirmMeaning"
                               OnCorrect="@(() => OnCorrectExercise(ReviewType.Input, ExerciseType.Onyomi))"
                               OnIncorrect="OnIncorrectMeaning"
                               CharacterForVerification="_character"/>
                       </div>);
        _exercises.Add(@<div class="fade-in-el">
                           <VerifyKunyomiByInput
                               OnConfirm="OnConfirmMeaning"
                               OnCorrect="@(() => OnCorrectExercise(ReviewType.Input, ExerciseType.Kunyomi))"
                               OnIncorrect="OnIncorrectMeaning"
                               CharacterForVerification="_character"/>
                       </div>);
        _exercises.Add(@<div class="fade-in-el">
                           <VerifyMeaningByPointing
                               CharacterForVerification="_character"
                               Culture="_culture"
                               OnCorrect="@(() => OnCorrectPointExercise(ExerciseType.Meaning))"
                               OnIncorrect="OnIncorrectMeaning"/>
                       </div>);
        _exercises.Add(@<div class="fade-in-el">
                           <VerifyMeaningByInput
                               OnConfirm="OnConfirmMeaning"
                               OnCorrect="@(() => OnCorrectExercise(ReviewType.Input, ExerciseType.Meaning))"
                               OnIncorrect="OnIncorrectMeaning"
                               CharacterForVerification="_character"/>
                       </div>);

        _exercises.Add(@<div class="fade-in-el">
                           <VerifyValueByInput OnConfirm="OnConfirmMeaning" CharacterForVerification="_character"/>
                       </div>);
    }

    private async Task OnCorrectPointExercise(ExerciseType exerciseType)
    {
        await Task.Delay(AfterAnswerDelay);
        await OnCorrectExercise(ReviewType.Point, exerciseType);
    }

    private async Task OnCorrectExercise(ReviewType reviewType, ExerciseType exerciseType)
    {
        await AddMeaningExerciseToReviewSession(isCorrect: true, reviewType, exerciseType);

        OnConfirmMeaning();
    }

    private async Task OnIncorrectMeaning()
    {
        await AddMeaningExerciseToReviewSession(isCorrect: false, ReviewType.Input, ExerciseType.Meaning);
    }

    private void OnConfirmMeaning()
    {
        GoToNextExerciseOrFinish();

        StateHasChanged();
    }

    private async Task GoToNextExerciseOrFinish()
    {
        if (_currentExcercise >= _exercises.Count - 1)
        {
            _reviewFinished = true;
        }
        else
        {
            _currentExcercise++;
        }

        if (_reviewFinished)
        {
            GetBaseReviewSessionResponse? review = await ReviewService.CreateReviewSessionAsync(_createReviewSessionRequest);
            NavigationManager.NavigateTo($"/review/Review-Result/{review?.Id}");
        }
    }

    private async Task AddMeaningExerciseToReviewSession(bool isCorrect, ReviewType reviewType, ExerciseType exerciseType)
    {
        var exercise = await ExerciseService
            .CreateExerciseAsync(new CreateExerciseRequest(_character!.Id,
                isCorrect: isCorrect,
                reviewType,
                exerciseType));

        _createReviewSessionRequest.ExerciseIds.Add(exercise!.Id);


        _reviewSession.Exercises.Add(exercise);

        await AppState.ReviewSessionState.UpdateReviewSession(_reviewSession);
    }

}